[{"content":"A useless security engineer/cn:å¸…å\nå·¥ä½œç»å†\nå­—èŠ‚è·³åŠ¨ï¼šç§»åŠ¨å®‰å…¨é£æ§å·¥ç¨‹å¸ˆï¼Œä¸“æ³¨åè‡ªåŠ¨åŒ–\nåä¸º: ç¡¬ä»¶å®‰å…¨ä¸ç§»åŠ¨å®‰å…¨å·¥ç¨‹å¸ˆï¼ŒTEE/HSM/æ¸—é€æµ‹è¯•/å®‰å…¨å¯åŠ¨ éƒ½åšè¿‡ç‚¹\nå­¦ä¹ ç»å†\næ—¥æœ¬ç­‘æ³¢å¤§å­¦ï¼Œç¤¾ä¼šå·¥å­¦ï¼Œç¡•å£«: å·®åˆ†éšç§ç ”ç©¶\nä¸­å—å¤§å­¦ï¼Œè®¡ç®—æœºç§‘å­¦ä¸æŠ€æœ¯ï¼Œæœ¬ç§‘: çç©å„¿\n","description":"","id":2,"section":"","tags":null,"title":"About Techsum","uri":"https://summersummer3.github.io/about/"},{"content":"æ¤­åœ†æ›²çº¿åŸºæœ¬å­¦ä¹  æ–‡ç« ï¼šhttps://andrea.corbellini.name/2015/05/17/elliptic-curve-cryptography-a-gentle-introduction/#elliptic-curves\nä¹¦ç±ï¼šå¯†ç å­¦åŸç†ä¸å®è·µ ç¬¬6ç« \næ¤­åœ†æ›²çº¿æ–¹ç¨‹ $$\n\\left\\lbrace (x, y) \\in \\mathbb{R}^2\\ |\\ y^2 = x^3 + ax + b,\\ 4 a^3 + 27 b^2 \\ne 0 \\right\\rbrace\\ \\cup\\ \\left\\lbrace 0 \\right\\rbrace\n$$\nç¾¤ä¸é˜¿è´å°”ç¾¤ â€‹\t$\\mathbb{G}$ æ˜¯ä¸€ä¸ª ç¾¤ (Group) å¦‚æœè¯¥é›†åˆä¸Šå®šä¹‰äº†ä¸€ç§è¿ç®— $ + $:\n å°é—­æ€§: $a \\in \\mathbb{G}, b \\in \\mathbb{G}$ ,åˆ™ $a + b \\in \\mathbb{G}$ ; ç»“åˆå¾‹: $a \\in \\mathbb{G}, b \\in \\mathbb{G}, c \\in \\mathbb{G}$, $ (a + b) + c = a + (b +c)$ ; å­˜åœ¨å•ä½å…ƒ $0 \\in \\mathbb{G}$, ä½¿å¾— $a \\in \\mathbb{G}$ï¼Œ$a + 0 = 0 + a = a$; æ¯ä¸€ä¸ªå…ƒç´ å­˜åœ¨é€†å…ƒï¼šå¯¹äºé›†åˆå†…ä»»æ„å…ƒç´ $a, \\exists b \\in \\mathbb{G}$ æ»¡è¶³ $a + b = 0$ï¼Œè®°åš$a = -b$  å¦‚æœè¯¥ç¾¤è¿˜æ»¡è¶³:\näº¤æ¢å¾‹ï¼š $a \\in \\mathbb{G}, b \\in \\mathbb{G}$ï¼Œ $a + b = b + a$  åˆ™è¯¥ç¾¤è¢«ç§°ä¸ºé˜¿è´å°”ç¾¤.\næœ‰é™åŸŸ $\\mathbb{F}$ æ˜¯ä¸€ä¸ª åŸŸ(Field) å¦‚æœè¯¥é›†åˆä¸Šå®šä¹‰äº†ä¸¤ç§è¿ç®— $(\\cdot\\ ;+)$\n å°é—­æ€§: $a \\in \\mathbb{F}, b \\in \\mathbb{F}$ï¼Œåˆ™ $a + b \\in \\mathbb{G}; a \\cdot b \\in \\mathbb{G}$ ç»“åˆå¾‹: $a \\in \\mathbb{F}, b \\in \\mathbb{F}, c \\in \\mathbb{F}$ï¼Œ$ (a + b) + c = a + (b +c);\\ (a \\cdot b) \\cdot c = a \\cdot (b \\cdot c)$ å­˜åœ¨åŠ æ³•å•ä½å…ƒ $0 \\in \\mathbb{F}$ï¼Œä½¿å¾— $a \\in \\mathbb{F}$ï¼Œ$a + 0 = 0 + a = a$ å­˜åœ¨ä¹˜æ³•å•ä½å…ƒ $e \\in \\mathbb{F}$ï¼Œä½¿å¾— $a \\in \\mathbb{F}$ï¼Œ$a \\cdot e = e \\cdot a = a$ äº¤æ¢å¾‹ï¼š $a \\in \\mathbb{F}, b \\in \\mathbb{F}$ï¼Œ $a + b = b + a$ï¼Œ$a \\cdot b = b \\cdot a$ é€†å…ƒ: å¯¹äºé›†åˆå†…ä»»æ„å…ƒç´ $a, \\exists b \\in \\mathbb{F}; \\exists c \\in \\mathbb{F}$ æ»¡è¶³ $a + b = 0; a \\cdot c = e$ï¼Œ è®°åš$a = -b;\\ a = c^{-1}$ï¼Œ$0^{-1}$æ— æ„ä¹‰ åˆ†é…å¾‹: $a \\in \\mathbb{F}, b \\in \\mathbb{F}, c \\in \\mathbb{F}$ï¼›$a \\cdot (b + c) = a \\cdot b + a \\cdot c$  æ³¨æ„ï¼šåŠ æ³•é€†å…ƒå®šä¹‰å‡æ³•ï¼Œä¹˜æ³•é€†å…ƒå®šä¹‰é™¤æ³•\næœ‰é™åŸŸæŒ‡çš„æ˜¯å…ƒç´ æœ‰é™çš„åŸŸï¼Œå±äºè®¡ç®—æœºå’Œå¯†ç å­¦çš„åŸºæœ¬æ•°å­¦åŸç†ä¹‹ä¸€\nå…¸å‹çš„æœ‰é™åŸŸä¾‹å­ï¼š$\\mathbb{F}_p = {0, 1, \u0026hellip;, p-1}$, $p$ä¸ºè´¨æ•°ï¼Œ\nå®šä¹‰ (+)ï¼š$a + b \\mod p$\nå®šä¹‰ ($\\cdot$)ï¼š$a \\cdot b \\mod p$\nè®¡ç®— $a ^ {-1}$ : æ‹“å±•æ¬§å‡ é‡Œå¾—ç®—æ³•\næ¤­åœ†æ›²çº¿ä¸Šçš„ç¾¤  æ›²çº¿ä¸Šçš„ç‚¹çš„é›†åˆç»„æˆç¾¤ $x$æ— ç©·è¿œç‚¹ä¸ºå•ä½å…ƒ$0$ ç‚¹$P$ä¸å®ƒçš„é€†$Q$å…³äºç›´çº¿$x = 0$å¯¹ç§° åŠ æ³•å®šä¹‰ï¼š$P + Q + R = 0$ï¼Œå¦‚æœè¿™ä¸‰ç‚¹æ˜¯é0ç‚¹ï¼Œä¸”åœ¨åŒä¸€æ¡ç›´çº¿ä¸Š(å³ä¸€æ¡ç›´çº¿ä¸è¯¥æ›²çº¿ç›¸äº¤äºä¸‰ç‚¹ï¼Œæ— ç©·è¿œç‚¹ä¸º0) $=\u0026gt; P + Q = -R$  åŠ æ³•åŒæ ·éœ€è¦æ»¡è¶³ç»“åˆå¾‹.\nå‡ ä½•æ„ä¹‰ä¸Šçš„åŠ æ³• æœ€é‡è¦çš„æƒ…å†µ:\n å¦‚æœ $P=Q, P + Q$ï¼Œç‰©ç†æ„ä¹‰æ˜¯åˆ‡çº¿, ä¸æ›²çº¿äº¤äºå¦ä¸€ç‚¹$R$, æ»¡è¶³ï¼š$2P = -R$ å¦‚æœ$P, Q$ç›´çº¿çš„ç¬¬ä¸‰ç‚¹åˆšå¥½ä¸º$P\\ or\\ Q$ï¼Œåˆ™ä¹Ÿå°†åŒ…å«ä¸€æ¡åˆ‡çº¿ï¼Œè®¡ç®—ç›¸åŒ: $P + Q + P = 0\\ =\u0026gt; P + Q = -P$  ä»£æ•°æ„ä¹‰ä¸Šçš„åŠ æ³• ä¸åŒä¸¤ç‚¹ç›¸åŠ  $P(P_x, P_y), Q(Q_x, Q_y)ï¼ŒP\\ \\ne Q$, æ±‚ $T(T_x, T_y) = P + Q$\næ›²çº¿æ–¹ç¨‹ï¼š$y^2 = x^3 +ax + b$\n  è®¡ç®—æ–œç‡ $k = \\frac{P_y - Q_y}{P_x - Q_x}$\n  æ›²çº¿æ–¹ç¨‹è¿ç«‹ä¸Šç›´çº¿æ–¹ç¨‹ $y = kx + c$\n=\u0026gt; $ 0 = x^3 - k^2x^2 + (a - 2kc)x + b - c^2$\n  é“­è®°ä¸‰æ¬¡æ±‚æ ¹å…¬å¼ä¹‹ä¸‰æ ¹ä¹‹å’Œæ˜¯äºŒæ¬¡é¡¹ç³»æ•°çš„ç›¸åæ•°: $T_x = k^2 - P_x - Q_x$\n  ç”±äºæ–œç‡ $k = \\frac{T_y - P_y}{T_x - P_x}$ï¼Œ$T_y = k(T_x - P_x) + P_y$\n  ç›¸åŒä¸¤ç‚¹ç›¸åŠ  $P(P_x, P_y)$ï¼Œæ±‚ $T(T_x,T_y) = P + P = 2P$\nå’Œä¸Šé¢åŸºæœ¬ç›¸åŒï¼Œä½†è®¡ç®—ç›´çº¿æ–œç‡éœ€è¦æ ¹æ®åˆ‡çº¿è®¡ç®—\nå¯¹æ›²çº¿æ–¹ç¨‹ä¸¤è¾¹æ±‚éšå¾®åˆ†:\n$\\mathrm{d}(y^2) = \\mathrm{d}(x^3 +ax + b)$ =\u0026gt; $2y\\mathrm{d}y = (3x^2 + a)\\mathrm{d}x$\nå°†$P_x, P_y$å¸¦å…¥ï¼Œè·å¾—æ–œç‡:\n$k = \\frac{\\mathrm{d}y}{\\mathrm{d}x} = \\frac{3P_x^2 + a}{2P_y}$\næ‰€ä»¥ $T_x = k^2 - 2P_x$ï¼Œ$T_y = k(T_x - P_x) + P_y$\næ ‡é‡ç§¯ $P(P_x, P_y)$ï¼Œæ±‚ $nP = \\underbrace{P + P + P + \u0026hellip; + P}_{\\text{n times}}$ï¼Œ$n \u0026gt; 2$\n  å°† $n$ ç”¨äºŒè¿›åˆ¶è¡¨ç¤ºï¼›ä»¥151ä¸ºä¾‹å­ï¼Œ$151_{10} = 10010111_2 = 2^0 + 2^1 + 2^2 + 2^4 + 2^7$\n  $nP = P + 2P + 2^2P + 2^4P + 2^7P$\n  æ ¹æ®ä¸Šé¢ä¸¤é¡¹è®¡ç®—è§„åˆ™ï¼Œåˆ†åˆ«è®¡ç®—$P, 2Pï¼ŒP + 2P$\n  è®¡ç®—$2^2P = 4P = 2 \\cdot 2P$ï¼Œå¯¹$2P$åšç›¸åŒç‚¹ç›¸åŠ å³å¯\n  åŒç†è®¡ç®—$2^3P = 8P = 2 \\cdot 4P$ï¼Œ$2^4P = 16P = 2 \\cdot 8P$, ä¾æ¬¡ç±»æ¨ï¼Œæ¯è®¡ç®—åˆ°ä¸€ä¸ªäºŒè¿›åˆ¶ä¸­ä¸º$1$çš„é˜¶æ•°ï¼Œ å®Œæˆä¸€æ¬¡ä¸¤ç‚¹ç›¸åŠ å³å¯\n  æ›²çº¿ä¸Šçš„æœ‰é™åŸŸ å–å‡ ä½•æ›²çº¿ä¸Šçš„åæ ‡$(x, y)$ï¼Œ$x, y \\in \\mathbb{F}_p$, $p$ æ˜¯ä¸€ä¸ªè´¨æ•°ï¼Œå½¢æˆä¸€æ¡ç¦»æ•£æ›²çº¿ï¼š\n$$\n\\begin{array}{rcl}\n\\left\\lbrace(x, y) \\in (\\mathbb{F}_p)^2 \\right. \u0026amp; \\left. | \\right. \u0026amp; \\left. y^2 \\equiv x^3 + ax + b \\pmod{p}, \\right.\n\\left. 4a^3 + 27b^2 \\not\\equiv 0 \\pmod{p}\\right\\rbrace\\ \\cup\\ \\left\\lbrace0\\right\\rbrace\n\\end{array}\n$$\nä»è¿ç»­æ›²çº¿ä¸Šçš„åŠ æ³•å¯ä»¥æ¨å‡ºæœ‰é™åŸŸä¸Šçš„åŠ æ³•å…¬å¼ï¼š\n$P(P_x, P_y), Q(Q_x, Q_y)ï¼ŒP\\ \\ne Q$, æ±‚ $T(T_x, T_y) = P + Q$\n$$\n\\begin{array}{rcl}\nk \u0026amp; = \u0026amp;(P_y - Q_y)(P_x - Q_x)^{-1} \\bmod{p} \\\nT_x \u0026amp; = \u0026amp; (k^2 - P_x - Q_x) \\bmod{p} \\\nT_y \u0026amp; = \u0026amp; [P_y + k(T_x - P_x)] \\bmod{p} \\\n\\end{array}\n$$\nè‹¥$P\\ = Q$\n$$\nk = (3 P_x^2 + a)(2 P_y)^{-1} \\bmod{p}\n$$\næ›²çº¿ä¸Šçš„å¾ªç¯å­ç¾¤ å¾ªç¯å­ç¾¤çš„é˜¶ å¯¹äºç¦»æ•£æ›²çº¿ä¸Šçš„ä»»æ„ç‚¹$P$, å­˜åœ¨æœ€å°çš„ $n$ ä½¿å¾— $nP = 0$, æ­¤æ—¶ $n$ ç§°ä½œä»¥ $P$ ä¸ºåŸºç‚¹çš„å¾ªç¯å­ç¾¤çš„é˜¶\næ‰¾åŸºç‚¹çš„æ–¹æ³•  è®¡ç®—æ¤­åœ†æ›²çº¿çš„é˜¶$N$ (Schoof\u0026rsquo;s algorithm: https://en.wikipedia.org/wiki/Schoof%27s_algorithm) é€‰æ‹©ä¸€ä¸ªé˜¶ä¸º$n$çš„å­ç¾¤ã€‚nå¿…é¡»æ˜¯ç´ æ•°ä¸”å¿…é¡»æ˜¯$N$çš„å› å­ è®¡ç®—è¾…å› å­ $h = N/n$ åœ¨æ›²çº¿ä¸Šé€‰æ‹©ä¸€ä¸ªéšæœºçš„ç‚¹ $T$ è®¡ç®—$G = hT$ï¼Œç‚¹ä¹˜ å¦‚æœ$G = 0$, è¿”å›4ï¼Œ å¦åˆ™æ‰¾åˆ°åŸºç‚¹ $G$, å­ç¾¤çš„é˜¶ä¸º $n$, $h$ è¢«ç§°ä¸ºè¾…å› å­  åŸç†: æ ¹æ®æ‹‰æ ¼æœ—æ—¥å®šç†ï¼Œ$n$ æ•´é™¤ $N$ ä¸” $n$ ä¸ºè´¨å› å­ï¼Œä¸”ä»»æ„ç‚¹ $T$ æ»¡è¶³$NT = 0$ï¼Œ åˆ™ï¼š$n(hT) = 0$ æ’æˆç«‹, é‚£ä¹ˆè‹¥$hT\\ \\ne 0$ï¼Œåˆ™ $hT$ ä½œä¸ºåŸºç‚¹çš„é˜¶ä¸€å®šä¸º$n$. ($n$ ä¸€å®šæ˜¯ç´ æ•°, å¦åˆ™ä¸æˆç«‹)\næ›²çº¿ä¸Šçš„ç¦»æ•£å¯¹æ•°é—®é¢˜ å¯¹äºæ›²çº¿ä¸Šçš„åŸºç‚¹ $G$ï¼Œ å·²çŸ¥ $n$ è®¡ç®— $P = nG$ æ˜¯å®¹æ˜“çš„\nä½†æ˜¯å·²çŸ¥$P, G$, è®¡ç®— $n$ æ˜¯å¾ˆå›°éš¾çš„\nECDH \u0026amp; ECDSA ECDH  CAé€‰ç”¨å…±åŒæ›²çº¿ï¼Œå¹¶ä¸‹å‘ç›¸åŒåŸºç‚¹$G$ï¼Œå…¶é˜¶æ•°ä¸º $n$, åˆ™ç§é’¥çš„å–å€¼èŒƒå›´ä¸º$d \\in {1, \u0026hellip;, n - 1}$ Aliceéšæœºé€‰æ‹©ç§é’¥$d_A$ï¼Œè®¡ç®— Pubkey: $P_A = d_AG$, é€šè¿‡éå®‰å…¨ä¿¡é“ä¼ é€’ç»™Bob Bobéšæœºé€‰æ‹©ç§é’¥$d_B$ï¼Œè®¡ç®— Pubkey: $P_B = d_BG$ï¼Œé€šè¿‡éå®‰å…¨ä¿¡é“ä¼ é€’ç»™Alice Aliceå’ŒBobåˆ†åˆ«è®¡ç®—$S = d_AP_b = d_BP_A = d_Ad_BG$ï¼Œ å…±äº«ç§˜å¯†æˆåŠŸ  ç§˜å¯†å…±äº«æˆåŠŸåå¯ä»¥æ¯æ¬¡é€šä¿¡æ—¶æ˜æ–‡ä¼ é€’salt, æ¯æ¬¡é€šè¿‡ $key = KDF(salt + S)$ï¼Œå¾—åˆ°å…·ä½“é€šä¿¡å¯¹ç§°ç§˜é’¥ï¼ŒåŠ å¯†é€šè®¯(TLS/SSL)\né€šè¿‡æœåŠ¡å™¨åŠ¨æ€ç”Ÿæˆçš„ECDHä¸€èˆ¬ç§°ä½œECDHE\nECDSA å®šä¹‰ä¾ç„¶ç»§æ‰¿ä¸Šæ–‡ï¼Œ$n$ ä¸º $G$ ä½œä¸ºåŸºç‚¹çš„å­ç¾¤é˜¶æ•°\nå®šä¹‰ $bit(x)$ ä¸ºè¡¨ç¤º $x$ éœ€è¦çš„æ¯”ç‰¹æ•°ï¼›æ³¨æ„è®¡ç®—DSAæ—¶ï¼Œè‹¥æ‘˜è¦å€¼çš„æ¯”ç‰¹æ•° $bits(digest(plain_test)) \u0026gt; bits(n)$ï¼Œåˆ™éœ€è¦æˆªå–æ‘˜è¦å€¼çš„ä½ $bits(n)$ è¿›è¡Œç­¾å.\nç¬¦å·æ ‡è®° æˆªå–å‰n-bitså‡½æ•° ï¼š $trun_{bit(n)}(digest)$\næˆªå–åçš„æ‘˜è¦å€¼ï¼š$z = trun_{bit(n)}(digest(plain_test))$ï¼Œ$digest$ éœ€è¦é€‰æ‹©å®‰å…¨æ‘˜è¦ç®—æ³•ï¼šå†…éƒ¨è¦æ±‚SHA-256ä»¥ä¸Š\nç§é’¥ï¼š$d$\nå…¬é’¥ï¼š$P = dG$\nç­¾åç®—æ³•   éšæœºé€‰æ‹© $k \\in {1, \u0026hellip;, n -1 }$\n  è®¡ç®—$T = kG = (T_x, T_y)$\n  è®¡ç®—æ•°å­— $r = T_x \\mod n$ï¼Œ è‹¥$r = 0$åˆ™è¿”å›1\n  è®¡ç®—$s = k^{-1}(z + rd) \\mod n$, å¦‚æœ$s = 0$ï¼Œè¿”å›1\n  æœ€åç­¾åï¼š$(r, s)$\n  éªŒè¯ç®—æ³•  è®¡ç®— $u_1 = s^{-1}z \\mod n$ è®¡ç®— $u_2 = s^{-1}r \\mod n$ è®¡ç®— $T\u0026rsquo; = u_1G\\ +\\ u_2P$  è‹¥$T\u0026rsquo;_x = r \\mod n$ï¼ŒéªŒç­¾æˆåŠŸï¼Œå¦åˆ™å¤±è´¥\næ­£ç¡®æ€§ æˆ‘ä»¬å°è¯•è®¡ç®—çš„å…¶å®è¿˜æ˜¯$T = kG$ï¼Œè‹¥æ­¤æ—¶ $z$ æ˜¯æ­£ç¡®æ‘˜è¦å€¼ï¼Œåˆ™æœ‰:\n$k = s^{-1}(z + rd)\\ mod\\ n\\ =\u0026gt;\\ k = s^{-1}z + s^{-1}rd \\mod n$\nå¸¦å…¥ä¸Šå¼ $T = s^{-1}zG + s^{-1}rdG = u_1G + u_2(dG) = u1G + u_2P$\næ‰€ä»¥è‹¥ $z$ å‘ç”Ÿæ”¹å˜ï¼Œåˆ™æ­¤æ—¶è®¡ç®—å‡ºæ¥çš„ $T\u0026rsquo;_x\\ \\ne\\ r \\mod n$\néšæœºæ•°ç›¸ç­‰ä¸‹çš„ç§é’¥å¤åŸ è‹¥æ¯æ¬¡å–å‡ºçš„éšæœºæ•° $k$ éƒ½ç›¸ç­‰ï¼š\nè·å–ä¸¤ä»½ç­¾åä¸æ‘˜è¦ï¼š$z_1, (r_1, s_1)$ å’Œ $z_2, (r_2, s_2)$\nå®¹æ˜“å¾—åˆ°: $r_1 = r_2 = (kG)_x \\mod n$\nä¹‹åé€šè¿‡ $s_1 - s_2$ è®¡ç®— $k$ï¼š\n$s_1 - s_2 = k^{-1}(z_1 + rd - z_2 - rd) \\mod n$\n$=\u0026gt; k = (z_1 - z_2)(s_1 - s_2)^{-1} \\mod n$\nä¹‹åè®¡ç®— $d$ å°±å¾ˆç®€å•äº†:\n$ d = r^{-1}(s_1k - z_1) \\mod n$\né€šè¿‡ç­¾åæ¢å¤å…¬é’¥ è‹¥å·²çŸ¥æ›²çº¿ä¸Š $x = r$ å¯¹åº”çš„ä¸¤ç‚¹ $R, R\u0026rsquo;$ï¼Œåˆ™å¯ä»¥ä»ç­¾å$(s, r)$ä¸­æ¢å¤å…¬é’¥$P$:\n$s = k^{-1}(z + rd) \\mod n$\n$=\u0026gt; skG = (z + rd)G$\næ³¨æ„ $kG = R$ æˆ–è€… $kG = R\u0026rsquo;$, åˆ†åˆ«ä½œä¸ºå¤‡é€‰å¸¦å…¥ä¸Šå¼ï¼ŒåŒæ—¶$P = dG$:\n$=\u0026gt;\\ sR - zG = r(dG)\\ =\u0026gt; P = r^{-1}(sR - zG)$\nor $=\u0026gt;\\ P = r^{-1}(sR\u0026rsquo; - zG)$\nå®ç°æ–¹æ³• ç‚¹å‹ç¼©ï¼šå¢åŠ 2bitæ¥æ ‡è¯†ï¼Œä¸€ä¸ªç”¨æ¥æ ‡è¯† $R_x = r\\mod n$ æˆ–è€… $R_x = r$ï¼Œå¦ä¸€ä¸ªæ ‡è¯†$R_y$æ˜¯åŸºæ•°è¿˜æ˜¯å¶æ•°ï¼š\nå› ä¸º$R, R\u0026rsquo;$å…³äº $x$ è½´å¯¹ç§°ï¼Œ$R_y + R\u0026rsquo;_y = 0 \\mod p$ï¼Œ æ‰€ä»¥$R_y ,P\u0026rsquo;_y$ä¸ºä¸€åŸºä¸€å¶ï¼Œå¯ç”¨ä¸€ä¸ªbitæ ‡è¯†\nè¿™æ ·å¯ä»¥è¾¾åˆ°å¤šç”¨å¢åŠ ä¸€ä¸ªbyte(04æ ‡è®°ç­‰)ï¼Œæ¥è¾¾æˆæ— éœ€ä¼ é€’å…¬é’¥å³å¯éªŒç­¾\nç›¸å…³ç®—æ³•ä¸ä»£ç ï¼šhttps://busy.org/@oflyhigh/397bw1\nä¼ªé€ ç­¾å æ„é€ eæ–¹æ³•  éšæœºé€‰æ‹© $a, b \\in {1, \u0026hellip; n}$, è®¡ç®—$T = aG + bP, r = T_x$ è®¡ç®— $s = rb^{-1}, e = arb^{-1}$ è‹¥$e$ ä¸ºä¼ªé€ æ‘˜è¦å€¼, å¯ä¼ªé€ åˆæ³•ç­¾å $(r, s)$  æ­£ç¡®æ€§:\n$u_1 = s^{-1}e \\mod \\ n$\n$u_2 = s^{-1}r \\mod\\ n$\nå°†$s, e$å¸¦å…¥\n$u_1G + u_2P = (rb^{-1})^{-1}(arb^{-1})G + (rb^{-1})^{-1}rP = (rr^{-1})(bb^{-1})aG + (rr^{-1})bP = aG + bP = T$\nç”±äº$r = T_x \\mod n$ï¼Œæ ¡éªŒé€šè¿‡\nç›¸å…³ç®—æ³•ä¸ä»£ç ï¼šhttps://github.com/GoldSaintEagle/ECDSA-SM2-Signing-Attack\nSM2ç­¾å æ ‡è®°ä¸å˜ï¼Œ$z = SM3(message)$ æ˜¯æ¶ˆæ¯çš„æ‘˜è¦å€¼ï¼ˆå›½å¯†è¦æ±‚æ‘˜è¦ä½¿ç”¨SM3ï¼‰ï¼Œ$d$ æ˜¯ç§é’¥ï¼Œ $P = dG$æ˜¯å…¬é’¥\nç­¾åç®—æ³•   éšæœºé€‰æ‹© $k \\in {1, \u0026hellip;, n -1 }$\n  è®¡ç®—$T = kG = (T_x, T_y)$\n  è®¡ç®—æ•°å­— $r = T_x + z \\mod n$ï¼Œ è‹¥$r = 0$åˆ™è¿”å›1\n  è®¡ç®—$s = (1 + d)^{-1}(k - rd) \\mod n$, å¦‚æœ$s = 0$ï¼Œè¿”å›1\n  æœ€åç­¾åï¼š$(r, s)$\n  éªŒè¯ç®—æ³•  è®¡ç®—æ¶ˆæ¯å€¼æ‘˜è¦$z\u0026rsquo; = SM3(message)$ è®¡ç®—$T\u0026rsquo; = sG + (r + s)P$ åˆ¤æ–­$r\\ ?= T\u0026rsquo;_x + z \\mod n$  æ­£ç¡®æ€§ é¦–å…ˆè®¡ç®— $k$ :\n$s = (1 + d)^{-1}(k - rd) \\mod n$\n=\u0026gt; $s(1 + d) + rd = k \\mod n$ =\u0026gt; $s + (s + r)d = k \\mod n$\næ‰€ä»¥ ï¼š\n$T = kG = sG + (s + r)(dG) = sG + (s + r)P = T'$\nå› æ­¤å¯ä»¥æ¨å¯¼ï¼š\n$r = (T_x + z) = (T\u0026rsquo;_x + z) \\mod n$\næ‰€ä»¥å¦‚æœ$r = T\u0026rsquo;_x + z\u0026rsquo; \\mod n$ï¼Œ åˆ™ $z\u0026rsquo;$ éªŒç­¾é€šè¿‡ï¼Œå¦åˆ™ $z\u0026rsquo;$ æ‘˜è¦æœ‰è¯¯\n","description":"æ¤­åœ†æ›²çº¿ç®—æ³•å…¥é—¨åŠECDSAä¸SM2ç®—æ³•è¯¦è§£","id":3,"section":"posts","tags":["å¯†ç å­¦"],"title":"ECDSAä¸SM2","uri":"https://summersummer3.github.io/posts/ecdsa%E4%B8%8Esm2/"},{"content":"èƒŒæ™¯ ç”±äºå¾ˆå¤šheadlessæµè§ˆå™¨çš„webglä¿¡æ¯æ¯”è¾ƒæ˜æ˜¾ï¼Œå¦‚æœæºç«™å°è¯•é‡‡é›†webglå‚æ•°ä¼šæš´éœ²è‡ªåŠ¨åŒ–å·¥å…·çš„ç‰¹å¾ï¼Œæ‰€ä»¥é»‘äº§æ”»å‡»ä¸­éœ€è¦å»æ¬ºéª—webglçš„ä¿¡æ¯ä¸ŠæŠ¥ã€‚\nç›®å‰åœ¨githubä¸Šå¯ä»¥æ‰¾åˆ°ä¸€ä¸ªspoof webglçš„é¡¹ç›®ï¼Œstaræ•°å¹¶ä¸å¤šï¼Œä½†å…¶æ€è·¯åº”è¯¥æ˜¯æ¯”è¾ƒä¸»æµçš„hook webglç›¸å…³æ¥å£çš„æ–¹å¼ã€‚æœ¬æ–‡ä¸»è¦å¯¹è¯¥å·¥å…·çš„ä½¿ç”¨å’Œæºç è¿›è¡Œåˆ†æã€‚\nè¿™ä»½ä»£ç å¹¶ä¸å®Œç¾ï¼Œç”šè‡³èƒ½æ‰¾åˆ°å‡ å¤„bugï¼Œä½†ä¸å¦¨ç¢æˆ‘ä»¬å­¦ä¹ å…¶æ€æƒ³ï¼›githubåœ°å€ï¼šhttps://github.com/siejqa/spoofHeadless\nèƒŒæ™¯çŸ¥è¯†ç®€å•ä»‹ç» Webglå’Œå‚æ•°é‡‡é›† ç®€å•æ¥è¯´webglå°±æ˜¯æµè§ˆå™¨ç»™å‰ç«¯jsä»£ç è°ƒç”¨çš„æ¸²æŸ“ç»˜å›¾APIï¼Œè¯¥APIå¯ä»¥åœ¨åœ¨html canvaså…ƒç´ ä¸­ä½¿ç”¨ï¼Œå¯ä»¥è°ƒç”¨åˆ°ç¡¬ä»¶è¿›è¡ŒåŠ é€Ÿï¼Œæ‰€ä»¥webglçš„å‚æ•°é€šå¸¸ä¸ç¡¬ä»¶å¼ºç›¸å…³ã€‚æ›´å…·ä½“çš„ä»‹ç»å’Œæ•™ç¨‹å¯ä»¥å‚è€ƒï¼šhttps://www.w3cschool.cn/webgl/i4gf1oh1.html\nå…·ä½“é‡‡é›†webglçš„å‚æ•°æ—¶ï¼Œéœ€è¦é¦–å…ˆå…ˆè·å–canvasä¸‹çš„webgl Contextï¼Œä½¿ç”¨getContextæ¥å£ã€‚è€Œé‡‡é›†å…·ä½“å‚æ•°æ˜¯ä½¿ç”¨getParameterå‡½æ•°å®Œæˆï¼ŒgetParameteræ¥å—ä¸€ä¸ªæ•´æ•°ï¼Œæ¯ä¸ªæ•´æ•°å¯¹åº”ä¸€ä¸ªå±æ€§ï¼›ä»¥è·å–GPUå‹å·ä¸ºä¾‹ï¼š\n1 2 3 4 5  // è·å–webgl context var gl = document.createElement(\u0026#34;canvas\u0026#34;).getContext(\u0026#34;webgl\u0026#34;) // é‡‡é›†GPU renderï¼šç¼–å·ä¸º37446 gl.getExtension(\u0026#34;WEBGL_debug_renderer_info\u0026#34;)[\u0026#34;UNMASKED_RENDERER_WEBGL\u0026#34;] gl.getParameter(37446)   å®Œæ•´çš„getParameterå¸¸é‡è¡¨å¯ä»¥å‚è€ƒï¼šhttps://developer.mozilla.org/en-US/docs/Web/API/WebGL_API/Constants\nWebdriver webdriveræœ¬è´¨ä¸Šæ˜¯æµè§ˆå™¨æ ¹æ®w3cå®ç°çš„ä¸€å¥—æ“ä½œæµè§ˆå™¨çš„æ¥å£ï¼Œè€Œæ¯ä¸ªæµè§ˆå™¨éƒ½æœ‰ä¸€ä¸ªç‰¹å®šçš„ WebDriver å®ç°ï¼Œå¦‚chrome webdriverï¼šhttps://chromedriver.chromium.org/downloads\nè€Œç›®å‰æ¯”è¾ƒå¹¿ä¹‰çš„å®šä¹‰ï¼ˆæˆ–è€…è¯´é»‘äº§ä½¿ç”¨çš„æ–¹å¼ï¼‰ï¼Œé€šå¸¸æ˜¯æŒ‡puppeteer/seleniumè¿™ç±»ï¼Œé›†æˆäº†å¤šç§æµè§ˆå™¨ï¼Œå¹¶æä¾›é«˜çº§apiä¾›ä¸Šå±‚åº”ç”¨è°ƒç”¨çš„è‡ªåŠ¨åŒ–å·¥å…·ï¼›å¯ä»¥ç›´æ¥ä½¿ç”¨python(selenium)å’Œnodejs(puppeteer)æ¥ç¼–å†™è„šæœ¬ï¼Œå®Œæˆwebdriverçš„æ§åˆ¶ï¼Œä»è€Œå®Œæˆæµè§ˆå™¨ä¸Šçš„è‡ªåŠ¨åŒ–æ“ä½œã€‚ç›¸å…³èµ„æ–™å¯ä»¥è‡ªè¡Œæœç´¢å­¦ä¹ ã€‚\nSpoofWebGLä½¿ç”¨æ–¹æ³• æ­¤å¤„ä»‹ç»å¦‚ä½•åœ¨seleniumä½¿ç”¨SpoofWebGLå·¥å…·ï¼Œå½“ç„¶è¯¥å·¥å…·ç®€å•æ”¹é€ åå¯ä»¥åœ¨æ‰€æœ‰çš„webdriverä¸Šä½¿ç”¨ã€‚\n å°†é¡¹ç›®cloneä¸‹æ¥ä¹‹åï¼Œä½¿ç”¨å¯ä»¥çœ‹åˆ°srcæ–‡ä»¶å¤¹ä¸‹æœ‰ä¸¤ä¸ªæ–‡ä»¶ï¼Œå…¶ä¸­manifest.jsonæ˜¯extensionçš„é…ç½®æ–‡ä»¶ï¼Œinjectedæ˜¯æºç ã€‚   ä¹‹åç”¨zipå‘½ä»¤å°†srcæ–‡ä»¶å¤¹æ‰“åŒ…ï¼šzip -rj extension.zip src/ å°†zipåç¼€åæ”¹æˆ.crx(chrome extensionçš„åç¼€å) ï¼šmv extension.zip extension.crx ç¼–å†™webdriverè„šæœ¬å¦‚ä¸‹ï¼ˆæ³¨æ„è¦å…ˆå®‰è£…å¥½seleniumå’Œchrome webdriverï¼‰ï¼Œå»è§‚å¯Ÿæˆ‘ä»¬çš„webglå‚æ•°è¯»å–æƒ…å†µï¼ˆæ³¨æ„åŸé¡¹ç›®ä¸­ä½¿ç”¨çš„æ˜¯firefoxçš„webdriverï¼Œæ‰€ä»¥è„šæœ¬è¦åšä¿®æ”¹ï¼‰ï¼š  1 2 3 4 5 6 7 8 9 10  from selenium import webdriver opt = webdriver.ChromeOptions() extension_path = \u0026#39;./extension.crx\u0026#39; opt.add_extension(extension_path) driver = webdriver.Chrome(options=opt) # Check what data is spoofed driver.get(\u0026#39;https://browserleaks.com/webgl\u0026#39;)   å¯ä»¥çœ‹åˆ°è¿™ä¸ªvendorå’Œrenderå·²ç»ä¸å¤ªæ­£å¸¸äº†ï¼›\n ä½œä¸ºå¯¹æ¯”ï¼Œæ³¨é‡Šæ‰optionsç›´æ¥å¯åŠ¨ï¼Œä¼šæ˜¾ç¤ºæœ¬æœºçš„çœŸå®GPUï¼š  1 2 3 4 5 6 7 8 9 10  from selenium import webdriver # opt = webdriver.ChromeOptions() #  # extension_path = \u0026#39;./extension.crx\u0026#39; # opt.add_extension(extension_path) driver = webdriver.Chrome() # Check what data is spoofed driver.get(\u0026#39;https://browserleaks.com/webgl\u0026#39;)   æ³¨ï¼šæ­¤å¤„æ˜¯ä½¿ç”¨æµè§ˆå™¨ç•Œé¢æ¨¡å¼æ‰“å¼€çš„ï¼Œå®é™…ä¸Šå¦‚æœæ˜¯å¯åŠ¨headlessæ¨¡å¼ï¼Œè¯¥rendererä¼šå’Œæœ¬æœºçš„æœ‰å·®åˆ«ï¼Œè¿™ä¹Ÿæ˜¯ä¸ºä»€ä¹ˆè¦ä½¿ç”¨spoof webglçš„åŸå› \næºç åˆ†æ æ€»ç»“æ¥è¯´ï¼Œè¯¥extensionæ˜¯å°†webglç›¸å…³çš„æ¥å£å…¨éƒ¨è¿›è¡Œäº†hookï¼Œæœ¬è´¨æŠ€æœ¯éš¾åº¦ä¸Šå¹¶ä¸å¤§ï¼Œä¸”å¯ä»¥å¾ˆå®¹æ˜“è¿›è¡Œå®šåˆ¶åŒ–ã€‚ä¸‹é¢å¼€å§‹å¯¹hookæ–¹æ³•è¿›è¡Œåˆ†æ\nwebdriverç›¸å…³ç»•è¿‡ å¼€å§‹çš„ç¬¬ä¸€éƒ¨åˆ†è·Ÿwebglæ£€æµ‹å…³ç³»ä¸å¤§ï¼Œä¸»è¦æ˜¯ç”¨definePropertyæ–¹æ³•å¯¹navigatorä¸‹ä¸€äº›å­—æ®µè¿›è¡Œäº†hookï¼Œç»•è¿‡webdriverç›¸å…³çš„ä¸€äº›æ£€æµ‹ï¼›ä¸»è¦æ˜¯è®¾ç½®ä¸Šæµè§ˆå™¨è¯­è¨€ï¼Œä»¥åŠå°†Navigator.webdriverç½®ä¸ºfalseï¼š\n1 2 3 4 5 6 7 8 9 10  Object.defineProperty(navigator, \u0026#39;languages\u0026#39;, { get: function () { var availableLanguages = Array(\u0026#39;en\u0026#39;, \u0026#39;pl\u0026#39;, \u0026#39;cs\u0026#39;, \u0026#39;ru\u0026#39;, \u0026#39;fr\u0026#39;, \u0026#39;fr-fr\u0026#39;, \u0026#39;lb\u0026#39;, \u0026#39;no\u0026#39;) return [\u0026#39;en-US\u0026#39;, get_random_item(availableLanguages)]; }, }); // fake webdriver property (headless has it as true) Object.defineProperty(navigator, \u0026#39;webdriver\u0026#39;, { get: () =\u0026gt; false, });   WebGL Hook æ ¹æ®ä¸Šæ–‡ä¸­webglè°ƒç”¨ç¤ºä¾‹å¯çŸ¥è°ƒç”¨webglæ¥å£é‡‡é›†å‚æ•°ä¸»è¦åˆ†ä¸ºä¸‰æ­¥ï¼š\n ä½¿ç”¨getContextè·å–webgl Context ä½¿ç”¨context.getExtensionè·å–webglæ‹“å±•çš„ç¼–å· ä½¿ç”¨context.getParameterè·å–å…·ä½“å‚æ•°çš„å€¼  å¯¹åº”æ­¥éª¤æˆ‘ä»¬æŸ¥çœ‹è¯¥è„šæœ¬çš„hookæ–¹æ³•ï¼š\nHTMLCanvasElement.getContext Hook è¦hookè¯¥æ–¹æ³•ï¼Œæˆ‘ä»¬éœ€è¦å…ˆå®šä¹‰ä¸€ä¸ªç±»ï¼Œå¦‚ä¸‹ï¼š\n1 2 3 4 5  function WebGLRenderingContext(canvas) { this.canvas = canvas; this.drawingBufferWidth = canvas.width; this.drawingBufferHeight = canvas.height; };   ä¹‹åå°†WebGLRenderingContextä¸­çš„åŸºæœ¬å±æ€§å’Œæ–¹æ³•è¿›è¡Œåˆå§‹åŒ–ï¼Œå³å¯¹Object.prototype.attributeè¿›è¡Œèµ‹å€¼ä¸€ä¸ªç©ºå‡½æ•°ã€‚æ³¨æ„ï¼ŒåŸºç¡€å±æ€§æœ¬è´¨ä¸Šéƒ½æ˜¯ä¸€äº›ç¼–å·ï¼Œå¦‚ä¸Šæ–‡ä¸­çš„ä¾‹å­ä¸€æ ·ï¼Œä»–æ˜¯ç”¨æ¥ä¼ å…¥getParameteråšå…¥å‚çš„ã€‚\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48  // åŸwebgl Contextä¸­çš„åŸºæœ¬æ–¹æ³•é›†åˆ var functions = [ \u0026#39;viewport\u0026#39;, \u0026#39;vertexAttribPointer\u0026#39;, \u0026#39;vertexAttrib4fv\u0026#39;, \u0026#39;vertexAttrib4f\u0026#39;, \u0026#39;vertexAttrib3fv\u0026#39;, ... ] // åŸwebgl Contextä¸­çš„åŸºæœ¬å±æ€§é›†åˆï¼Œè¿™é‡ŒæŒ‘é€‰ä¸€äº›ç»å¸¸è¢«æ”¶é›†çš„ä½œä¸ºä¾‹å­ var enumerates = { ... \u0026#39;VERSION\u0026#39;: 7938, ... \u0026#39;UNMASKED_VENDOR_WEBGL\u0026#39;: 37445, \u0026#39;UNMASKED_RENDERER_WEBGL\u0026#39;: 37446, ... \u0026#39;DEPTH_BITS\u0026#39;: 3414, \u0026#39;GREEN_BITS\u0026#39;: 3411, \u0026#39;BLUE_BITS\u0026#39;: 3412, ... \u0026#39;STENCIL_BITS\u0026#39;: 3415, ... \u0026#39;MAX_VERTEX_UNIFORM_VECTORS\u0026#39;: 36347, \u0026#39;MAX_VERTEX_TEXTURE_IMAGE_UNITS\u0026#39;: 35660, \u0026#39;MAX_VERTEX_ATTRIBS\u0026#39;: 34921, \u0026#39;MAX_VARYING_VECTORS\u0026#39;: 36348, \u0026#39;MAX_TEXTURE_SIZE\u0026#39;: 3379, \u0026#39;MAX_TEXTURE_IMAGE_UNITS\u0026#39;: 34930, \u0026#39;MAX_RENDERBUFFER_SIZE\u0026#39;: 34024, \u0026#39;MAX_FRAGMENT_UNIFORM_VECTORS\u0026#39;: 36349, \u0026#39;MAX_CUBE_MAP_TEXTURE_SIZE\u0026#39;: 34076, \u0026#39;MAX_COMBINED_TEXTURE_IMAGE_UNITS\u0026#39;: 35661, ... }; // å°†åŸæœ¬çš„å‡½æ•°å…¨éƒ¨æ›¿æ¢æˆç©ºå‡½æ•° functions.forEach(function (func) { WebGLRenderingContext.prototype[func] = function () { return {}; }; }); Object.keys(enumerates).forEach(function (key) { WebGLRenderingContext.prototype[key] = enumerates[key]; });   å®é™…ä¸ŠåŸè„šæœ¬ä¹‹åé©¬ä¸Šå¯¹context.getExtensionå®Œæˆäº†èµ‹å€¼ï¼Œé‚£æ­¤å¤„å…¶å®é¡ºåºä¸å½±å“æ‰§è¡Œç»“æœï¼Œæ‰€ä»¥æˆ‘ä»¬ç•™åœ¨ä¸‹ä¸€èŠ‚æè¿°ã€‚\nè¿›å…¥hookçš„ä»£ç ï¼Œå®é™…ä¸Šdocument.createElement(\u0026ldquo;canvas\u0026rdquo;).getContext(\u0026quot;webgl\u0026quot;)è°ƒç”¨åˆ°çš„æ˜¯HTMLCanvasElement.getContextæ–¹æ³•ï¼Œæ‰€ä»¥å¯¹è¯¥æ–¹æ³•è¿›è¡ŒHookï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26  try { const getContext = HTMLCanvasElement.prototype.getContext; // åˆ©ç”¨é‡å®šä¹‰HTMLCanvasElement.prototype.getContextå®ŒæˆHookï¼Œæ˜¯å¸¸è§çš„hookæ–¹æ³•  HTMLCanvasElement.prototype.getContext = function () { // è·å–ç¬¬ä¸€ä¸ªå…¥å‚ï¼Œé€šå¸¸ä¸º\u0026#34;webgl\u0026#34;ï¼Œ\u0026#39;webgl-experimental\u0026#39;ç­‰  var name = arguments[0]; console.log(\u0026#34;HTMLCanvasElement app requested extension: \u0026#34; + name); console.log(JSON.stringify(arguments, null, 4)); if (name == \u0026#39;webgl\u0026#39; || name == \u0026#39;webgl-experimental\u0026#39; || name == \u0026#39;experimental-webgl\u0026#39; || name == \u0026#39;moz-webgl\u0026#39;) { // æœ€ç»ˆè¿”å›äº†ä¸Šæ–‡ä¸­è‡ªå®šä¹‰çš„ç±»WebGLRenderingContextï¼Œå®Œæˆhook  var y = new WebGLRenderingContext(this); console.log(\u0026#34;WEBGL \u0026#34; + y); console.log(JSON.stringify(y, null, 4)); return y; } // å…¶ä»–çš„webglç±»å‹ä¸æ”¯æŒï¼Œè¿”å›åŸå§‹æ•°æ®  if (name == \u0026#39;webgl2\u0026#39; || name == \u0026#39;experimental-webgl2\u0026#39; || name == \u0026#39;fake-webgl\u0026#39;) { console.log(\u0026#34;WEBGL2\u0026#34;) return null; } var ext = getContext.apply(this, arguments); console.log(\u0026#34;HTMLCanvasElement extension \u0026#34; + name + \u0026#34; \u0026#34; + (ext ? \u0026#34;found\u0026#34; : \u0026#34;not found\u0026#34;)); console.log(ext); return ext; } } catch (e) { }   context.getExtensionå®šä¹‰ å®é™…ä¸Šå¾ˆç®€å•ï¼Œåªéœ€è¦getå¯¹åº”å±æ€§æ—¶è¿”å›æŒ‡å®šç¼–å·å³å¯ï¼Œæ­¤å¤„ä»¥ä¸Šæ–‡ä¸­çš„\u0026quot;WEBGL_debug_renderer_info\u0026quot;ä¸ºä¾‹å­ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14  var extensions = { // ratified  ... \u0026#39;WEBGL_debug_renderer_info\u0026#39;: { \u0026#39;UNMASKED_VENDOR_WEBGL\u0026#39;: 37445, \u0026#39;UNMASKED_RENDERER_WEBGL\u0026#39;: 37446 }, ... } WebGLRenderingContext.prototype.getExtension = function (ext) { console.log(\u0026#34;WebGLRenderingContext.getExtension\u0026#34; + ext); return extensions[ext]; };   æ³¨æ„æ­¤å¤„æœ‰ä¸€äº›ç‰¹ä¾‹æ˜¯\u0026quot;WEBGL_lose_context\u0026quot;å’Œ\n\u0026ldquo;WEBGL_draw_buffers\u0026rdquo;, ä»–ä»¬çš„å±æ€§å†…éƒ¨åŒ…å«æ–¹æ³•ï¼Œéœ€è¦å®šä¹‰ä¸€ä¸‹ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23  function loseContext () { } function restoreContext () { } function drawBuffersWEBGL () { } var extensions = { // ratified  ... \u0026#39;WEBGL_lose_context\u0026#39;: { loseContext, restoreContext }, ... \u0026#39;WEBGL_draw_buffers\u0026#39;: { \u0026#39;MAX_DRAW_BUFFERS_WEBGL\u0026#39;: 34852, \u0026#39;MAX_COLOR_ATTACHMENTS_WEBGL\u0026#39;: 36063, ... drawBuffersWEBGL }, }   context.getParameter å®šä¹‰ï¼Œå®Œæˆå–å€¼çš„Hook ä»£ç å¯ä»¥æ‹†è§£å¦‚ä¸‹ï¼š\n å®šä¹‰éƒ¨åˆ†ï¼Œæ‹¿åˆ°getParameterçš„å‚æ•°ï¼š  1 2 3 4 5 6 7  try { const getParameter = WebGLRenderingContext.prototype.getParameter; WebGLRenderingContext.prototype.getParameter = function () { var name = arguments[0]; console.log(\u0026#34;WebGLRenderingContext - getParameter: \u0026#34; + name); ... } catch (a) { }    Hook UNMASKED_VENDOR_WEBGL å’ŒUNMASKED_RENDERER_WEBGL å‚æ•°ï¼Œä»ä¸€ä¸ªå¤‡é€‰åˆ—è¡¨ä¸­éšæœºè¿”å›ä¸€ä¸ªvendor/rendererï¼Œå¯ä»¥å¾ˆå¥½çš„é˜²æ­¢æ”¶é›†ä¿¡æ¯ç»“æœè¿‡åº¦é›†ä¸­ï¼Œä¹Ÿå¯ä»¥å¾ˆæ–¹ä¾¿çš„è¿›è¡Œæ‹“å±•ï¼š  1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17  function get_random_item(list) { return list[Math.floor((Math.random() * list.length))]; } WebGLRenderingContext.prototype.getParameter = function () { ... // UNMASKED_VENDOR_WEBGL  if (name == 37445) { var options = [\u0026#39;Intel Open Source Technology Center\u0026#39;, \u0026#39;X.Org\u0026#39;, \u0026#39;Vendor Google Inc.\u0026#39;]; return get_random_item(options); } else if (name == 37446) { // UNMASKED_RENDERER_WEBGL  var options = [\u0026#39;Mesa DRI Intel(R) Ivybridge Mobile\u0026#39;, \u0026#39;AMD KAVERI (DRM 2.43.0 / 4.4.0-119-generic, LLVM 5.0.0)\u0026#39;, \u0026#39;Renderer Google SwiftShader\u0026#39;, \u0026#39;AMD ARUBA (DRM 2.43.0 / 4.4.0-119-generic, LLVM 5.0.0)\u0026#39;, \u0026#39;Mesa DRI Intel(R) HD Graphics 630 (Kaby Lake GT2)\u0026#39;, \u0026#39;Gallium 0.4 on AMD KAVERI (DRM 2.43.0 / 4.4.0-83-generic, LLVM 3.8.0)\u0026#39;]; return get_random_item(options); } ... }    Hook ä¸€äº›åŸºç¡€å±æ€§, å¦‚RENDERER / VENDOR / SHADING_LANGUAGE_VERSION /  VERSION\n1 2 3 4 5 6 7 8 9 10 11 12 13 14  WebGLRenderingContext.prototype.getParameter = function () { ... else if (name == 7937 || name == 7936) { // RENDERER // VENDOR  return \u0026#39;Mozilla\u0026#39;; } else if (name == 35724) { // SHADING_LANGUAGE_VERSION  return \u0026#39;WebGL GLSL ES 1.0\u0026#39;; } else if (name == 7937 || name == 7938) { // VERSION  return \u0026#39;WebGL 1.0\u0026#39;; } ... }    Hook ALIASED_LINE_WIDTH_RANGE / ALIASED_POINT_SIZE_RANGE, ä¼šè¿”å›ä¸€ä¸ªfloat arrayï¼Œsizeä¸º2ï¼›è¿™é‡Œä»£ç æœ‰ç‚¹å°é—®é¢˜ï¼Œä¸å½±å“åŠŸèƒ½ï¼Œname == 7937æ˜¯VERSIONï¼Œä¸è¿‡åœ¨ä¸Šé¢å·²ç»åˆ¤æ–­è¿‡äº†ï¼Œä¸ä¼šè¿›åˆ°è¿™ä¸ªåˆ†æ”¯ï¼š  1 2 3 4 5 6 7 8 9  WebGLRenderingContext.prototype.getParameter = function () { ... else if (name == 7937 || name == 33901 || name == 33902) { // ALIASED_LINE_WIDTH_RANGE // ALIASED_POINT_SIZE_RANGE  var option = new Float32Array([1, 8192]); return option; } ... }    é’ˆå¯¹ä¸€äº›webglä½å®½ä¿¡æ¯è¿›è¡ŒHookï¼Œè¿”å›éšæœºå€¼[2, 4, 8, 16]ä¸­1ä¸ªï¼Œå…·ä½“å‚æ•°è§æ³¨é‡Šï¼š  1 2 3 4 5 6 7 8  WebGLRenderingContext.prototype.getParameter = function () { ... else if (name == 3413 || name == 3412 || name == 3411 || name == 3410 || name == 34852) { // ALPHA_BITS // BLUE_BITS // GREEN_BITS // RED_BITS // MAX_DRAW_BUFFERS_WEBGL  return get_random_item([2, 4, 8, 16]); } ... }    é’ˆå¯¹ä¸€äº›ä½å®½ä¿¡æ¯è¿›è¡ŒHookï¼Œè¿”å›å›ºå®šå€¼ï¼Œå‚æ•°è§æ³¨é‡Š  1 2 3 4 5 6 7 8 9 10 11  WebGLRenderingContext.prototype.getParameter = function () { ... else if (name == 3415) // STENCIL_BITS  return 0; } else if (name == 3414) { // DEPTH_BITS  return 24; } ... }    æ¥ä¸‹æ¥æ˜¯è¯¥è„šæœ¬bugçš„åœ°æ–¹ï¼ŒHookå‡ºç°é—®é¢˜ï¼Œå¦‚æœä½¿ç”¨è¯¥è„šæœ¬ä¸åŠ ä¿®æ”¹ï¼Œå¾ˆå®¹æ˜“é€šè¿‡æ­¤bugè¯†åˆ«ï¼›åŸå› ä¸»è¦åœ¨äºä»¥ä¸‹hookçš„ä¸‰ä¸ªå‚æ•°å€¼ç†è®ºä¸Šæ˜¯è¿”å›ä¸€ä¸ªæ•´æ•°ï¼Œä½†ä¸çŸ¥ä¸ºä½•ä½œè€…è¿™é‡Œä½¿ç”¨äº†get_random_items, ä½†æ²¡æœ‰ç»™ç¬¬äºŒä¸ªå‚æ•°ï¼Œæ‰€ä»¥nä¼šä¸ºundefinedï¼Œå¯¼è‡´å›ºå®šè¿”å›ä¸€ä¸ªArrayï¼šundefinedï¼›ä¿®å¤ä¹Ÿå¾ˆç®€å•ï¼Œæ¢æˆget_random_itemå³å¯ã€‚æºä»£ç å¦‚ä¸‹ï¼š  1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26  function get_random_items(list, n) { var result = new Array(n), len = list.length, taken = new Array(len); if (n \u0026gt; len) n = len while (n--) { var x = Math.floor(Math.random() * len); result[n] = list[x in taken ? taken[x] : x]; // æ¯”è¾ƒå·§å¦™çš„å–éšæœºå¤šä¸ªå€¼çš„æ–¹å¼ï¼Œç•™ä¸€ä¸ªarrayæ ‡è®°å¦‚æœä¸‹æ¬¡å†å–åˆ°å…¶ä¸‹æ ‡ä¼šä»ç›®å‰æœªå–æˆçš„æœ€åä¸€ä¸ªå…ƒç´   taken[x] = --len in taken ? taken[len] : len; } return result; } WebGLRenderingContext.prototype.getParameter = function () { ... else if (name == 34047 || name == 34921) { // MAX_TEXTURE_MAX_ANISOTROPY_EXT // MAX_VERTEX_ATTRIBS  return get_random_items([2, 4, 8, 16]); } else if (name == 35661) { // MAX_COMBINED_TEXTURE_IMAGE_UNITS  return get_random_items([128, 192, 256]); } ... }    å¯¹ä¸€äº›å…¶ä»–çš„MAXç›¸å…³å±æ€§è¿›è¡ŒHookï¼Œè¿”å›éšæœºå€¼ï¼Œå…·ä½“å±æ€§è§æ³¨é‡Š  1 2 3 4 5 6 7 8 9 10 11 12 13 14  WebGLRenderingContext.prototype.getParameter = function () { ... } else if (name == 34076 || name == 34024 || name == 3379) { // MAX_CUBE_MAP_TEXTURE_SIZE // MAX_RENDERBUFFER_SIZE  return get_random_item([16384, 32768]) ; } else if (name == 36349 || name == 36347) { // MAX_FRAGMENT_UNIFORM_VECTORS // MAX_VERTEX_UNIFORM_VECTORS  return get_random_item([4096, 8192]); } else if (name == 34930 || name == 36348 || name == 35660) { // MAX_TEXTURE_IMAGE_UNITS // MAX_VARYING_VECTORS // MAX_VERTEX_TEXTURE_IMAGE_UNITS  return get_random_item([16, 32, 64]); } ... }    å¯¹MAX_VIEWPORT_DIMSè¿›è¡ŒHookï¼Œä¼šè¿”å›ä¸€ä¸ªé•¿åº¦ä¸º2ä¸”ä¸¤ä¸ªå€¼ç›¸ç­‰çš„Int32Arrayï¼ŒåŒæ ·æ­¤å¤„éšæœºå–å€¼ï¼š  1 2 3 4 5 6 7 8 9 10  WebGLRenderingContext.prototype.getParameter = function () { ... else if (name == 3386) { // MAX_VIEWPORT_DIMS  var value = get_random_item([8192, 16384, 32768]) var options = new Int32Array([value, value]); return options; } ... }    æœ€åï¼Œå‰©ä¸‹çš„å‚æ•°ç»Ÿä¸€éšæœºä»[0, 2, 4, 8, 16, 32, 64, 128, 256, 512, 1024, 2048, 4096]éšæœºå–å€¼è¿”å›(æ­¤å¤„è¿˜æœ‰ä¸ªå†—ä½™åˆ†æ”¯STENCIL_BITSï¼Œä¸Šé¢å·²ç»åˆ¤æ–­è¿‡äº†ï¼Œå±äºå†—ä½™ä»£ç )  1 2 3 4 5 6 7 8  WebGLRenderingContext.prototype.getParameter = function () { ... else { console.log(\u0026#34;Retuning random value for: \u0026#34; + name); return get_random_item([0, 2, 4, 8, 16, 32, 64, 128, 256, 512, 1024, 2048, 4096]); } ... }    æœ€åçš„è¿·æƒ‘æ“ä½œï¼šç†è®ºä¸Šæ­¤å¤„å·²ç»æ¶µç›–äº†æ‰€æœ‰çš„caseè¿”å›ï¼Œä½†æ˜¯æœ€åè¿˜å¤šäº†ä¸ªè·‘ä¸åˆ°çš„åˆ†æ”¯ï¼š  1 2 3 4 5 6 7 8  WebGLRenderingContext.prototype.getParameter = function () { ... var ext = getParameter.apply(this, arguments); console.log(\u0026#34;WebGLRenderingContext extension \u0026#34; + name + \u0026#34; \u0026#34; + (ext ? \u0026#34;found\u0026#34; : \u0026#34;not found\u0026#34;)); console.log(JSON.stringify(ext, null, 4)); return ext; }   è¯´å®è¯æˆ‘çŒœæµ‹æ­¤å¤„ä»–æ˜¯æƒ³æ¨¡æ‹Ÿä¸€äº›å‚æ•°ï¼Œä»–ä»¬åœ¨getParameterä¹‹å‰å¿…é¡»å…ˆè°ƒç”¨getExtensionæ–¹æ³•åæ‰å¯ä»¥è·å–ï¼Œä½†æ˜¯æ­¤å¤„åŠ åœ¨æœ€åå±å®çœ‹ä¸æ‡‚ï¼Œä¸ªäººç†è§£åº”è¯¥æ”¾åœ¨è¿™ä¸ªå¤§if\u0026hellip;else\u0026hellip;å‰é¢ï¼›æœ‰æ—¶é—´æˆ‘å¯ä»¥å¥½å¥½ä¿®å¤ä¸€ä¸‹è¿™ä¸ªé¡¹ç›®ğŸ˜‚ğŸ˜‚\nå…¶ä»–çš„ä¸€äº›è¢«Hookçš„æ–¹æ³•  getSupportedExtensionï¼šæ¯”è¾ƒç®€å•ï¼Œéšæœºä»extensionsä¸­é—´é€‰æ‹©éšæœºä¸ªkeyså¹¶è¿”å›ï¼Œå‡ºç°å¼‚å¸¸åˆ™å°†æ‰€æœ‰çš„keyséƒ½è¿”å›ã€‚  1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17  // extensionsçš„keyså¯ä»¥å‚è§getExtensionéƒ¨åˆ† const getSupportedExtensions = WebGLRenderingContext.prototype.getSupportedExtensions; WebGLRenderingContext.prototype.getSupportedExtensions = function () { try { console.log(\u0026#34;WebGLRenderingContext.getSupportedExtensions\u0026#34;) var availableExtensions = Object.keys(extensions); console.log(availableExtensions); var itemsToGet = Math.floor(Math.random() * (availableExtensions.length - 6) + 5); console.log(itemsToGet); var selectedExtensions = get_random_items(availableExtensions, itemsToGet); console.log(selectedExtensions); return selectedExtensions; } catch (a) { console.log(a) return Object.keys(extensions); } }    é’ˆå¯¹ä¸€äº›headlessæµè§ˆå™¨æœ‰å¯èƒ½ä¼šå‡ºç°canvasçš„ä¸€äº›å±æ€§å¼‚å¸¸ï¼ˆbrokenä¼šä¸º0ï¼‰ï¼Œå¦‚canvasçš„widthå’Œheightï¼Œä»¥åŠoffsetï¼Œè¿›è¡ŒHookï¼Œè¿˜æ˜¯ä½¿ç”¨definePropertyé‡å†™getæ–¹æ³•å¯¹å±æ€§è¿›è¡Œhookï¼š  1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32  // in case of broken image return random height/width var size = 0; [\u0026#39;height\u0026#39;, \u0026#39;width\u0026#39;].forEach(property =\u0026gt; { const imageDescriptor = Object.getOwnPropertyDescriptor(HTMLImageElement.prototype, property); Object.defineProperty(HTMLImageElement.prototype, property, { imageDescriptor, get: function () { // å¦‚æœcanvasç ´æŸï¼Œåˆ™è¿”å›éšæœºsize  if (this.complete \u0026amp;\u0026amp; this.naturalHeight == 0) { if (!size) { // è¿”å›éšæœºçš„é•¿/å®½  size = Math.floor(Math.random() * (30 - 10 + 1)) + 10; } return size; } // æœªç ´æŸåˆ™è¿”å›æ­£å¸¸size  return imageDescriptor.get.apply(this); }, }); }); // hairline feature (headless can\u0026#39;t render it normally) const imageDescriptor = Object.getOwnPropertyDescriptor(HTMLElement.prototype, \u0026#39;offsetHeight\u0026#39;); Object.defineProperty(HTMLElement.prototype, \u0026#39;offsetHeight\u0026#39;, { ...imageDescriptor, get: function () { if (this.id == \u0026#39;modernizr\u0026#39;) { return 1; } return imageDescriptor.get.apply(this); }, });   æ’ä»¶æ‰§è¡Œ æ–¹æ³•æ¯”è¾ƒç®€å•ï¼Œå°†æ•´ä¸ªå¤§å‡½æ•°ä½œä¸ºå­—ç¬¦ä¸²ï¼Œæœ€ååœ¨html documentä¸­æ–°å»ºä¸€ä¸ªscript tagï¼Œscript.textContentèµ‹å€¼ä¸ºå­—ç¬¦ä¸²å³å¯ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22  var scriptCode = \u0026#39;(\u0026#39; + function () { ... function WebGLRenderingContext(canvas) { ... }; ... WebGLRenderingContext.prototype.getExtension = function (ext) { ... }; ... WebGLRenderingContext.prototype.getParameter = function () { ... } ... } + \u0026#39;)();\u0026#39;; // è½¬æˆå­—ç¬¦ä¸²ï¼Œå¯ç›´æ¥æ‰§è¡Œ  // æ–°å»ºscriptèŠ‚ç‚¹æ’å…¥documentä¸­ï¼Œå³è‡ªåŠ¨æ‰§è¡Œ var script = document.createElement(\u0026#39;script\u0026#39;); script.textContent = scriptCode; (document.head || document.documentElement).appendChild(script); // æœ€åmoveæ‰ä»£ç å³å¯ script.remove();   ","description":"SpoofWebGL","id":4,"section":"posts","tags":["é»‘äº§å·¥å…·"],"title":"SpoofWebGL","uri":"https://summersummer3.github.io/posts/spoofwebgl/"}]